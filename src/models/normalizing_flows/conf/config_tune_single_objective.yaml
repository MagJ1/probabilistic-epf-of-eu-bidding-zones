# src/models/normalizing_flows/conf/config_tune.yaml
defaults:
  - data: ???
  - model: ???           
  - features: calendar    
  - logging: default
  - train: ???        # reuse train block
  - _self_

# experiment metadata
model_type: normalizing_flows
seed: 42


# Optuna/tuning settings
tune:
  study_name: ???   # unique per size/exp
  storage: sqlite:///optuna_flows_${model.size}.db      # toggle persistence
  direction: minimize
  metric: [val_es]
  n_trials: 30
  timeout: null            # or in seconds, e.g. 7200
  sampler: tpe             # for multi: nsgaii or motpe
  pruner: prune             # keep simple first

  # per-size search ranges (kept tight and feasible)
  space:
    tiny:
      tf_in_size:      [32, 64, 128]         # must be divisible by n_heads
      n_heads:         [1, 2, 4, 8]         # must divide tf_in_size
      n_layers:        [2, 4, 8, 6, 12]        # encoder/decoder layers
      nf_hidden_dim:   [16, 32, 64, 128, 256]    # MADE hidden size
      n_flow_layers:   [4, 6, 8, 10, 12]        # MAF depth
      n_made_blocks:   [1, 2]
      tf_dropout:      [0.0, 0.3]        # continuous, uniform
      lr_log10:        [-5.5, -3.5]      # sample log10 LR
      warmup_epochs:   [0, 1, 2, 3, 4, 5]            # integer

    small:
      tf_in_size:      [192, 256]
      n_heads:         [4, 8, 16]
      n_layers:        [8, 12, 16]
      nf_hidden_dim:   [128, 256]
      n_flow_layers:   [8, 12, 16]
      n_made_blocks:   [1, 2, 3]
      tf_dropout:      [0.0, 0.1]
      lr_log10:        [-4.0, -3.5]
      warmup_epochs:   [0, 1, 2, 3]

    base:
      tf_in_size:      [256, 384]
      n_heads:         [4, 8, 16]
      n_layers:        [12, 16, 20]
      nf_hidden_dim:   [256, 512]
      n_flow_layers:   [16, 20]
      n_made_blocks:   [1, 2, 3]
      tf_dropout:      [0.0, 0.1]
      lr_log10:        [-4.0, -3.5]
      warmup_epochs:   [0,1,2,3]

out_root: outputs/${model_type}/${model.size}/tuning/${tune.study_name}

hydra:
  run:
    dir: ${out_root}     # hydra chdirs here (weâ€™ll nest trial dirs within)
  job:
    chdir: true